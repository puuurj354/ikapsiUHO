version: "3.8"

services:
    ikapsi-db:
        image: mysql:8.0
        container_name: ikapsi-db
        restart: unless-stopped
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password_change_me}
            MYSQL_DATABASE: ${DB_DATABASE:-ikapsi_db}
            MYSQL_USER: ${DB_USERNAME:-ikapsi_user}
            MYSQL_PASSWORD: ${DB_PASSWORD:-ikapsi_password_change_me}
            MYSQL_ROOT_HOST: "%"
        command:
            - --default-authentication-plugin=mysql_native_password
            - --character-set-server=utf8mb4
            - --collation-server=utf8mb4_unicode_ci
            - --max_allowed_packet=256M
            - --innodb_buffer_pool_size=512M
        volumes:
            - ikapsi-mysql-data:/var/lib/mysql
            - ./docker/mysql/init:/docker-entrypoint-initdb.d
        networks:
            - ikapsi-net
        healthcheck:
            test:
                [
                    "CMD",
                    "mysqladmin",
                    "ping",
                    "-h",
                    "localhost",
                    "-u",
                    "root",
                    "-p${DB_ROOT_PASSWORD:-root_password_change_me}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    ikapsi-app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: ikapsi-app
        restart: unless-stopped
        depends_on:
            ikapsi-db:
                condition: service_healthy
        environment:
            # App Configuration
            - APP_NAME=iKAPSI UHO
            - APP_ENV=${APP_ENV:-production}
            - APP_KEY=${APP_KEY}
            - APP_DEBUG=${APP_DEBUG:-false}
            - APP_URL=${APP_URL:-https://ikapsi.horus.my.id}

            # Database Configuration
            - DB_CONNECTION=mysql
            - DB_HOST=ikapsi-db
            - DB_PORT=3306
            - DB_DATABASE=${DB_DATABASE:-ikapsi_db}
            - DB_USERNAME=${DB_USERNAME:-ikapsi_user}
            - DB_PASSWORD=${DB_PASSWORD:-ikapsi_password_change_me}

            # Cache Configuration
            - CACHE_STORE=database
            - SESSION_DRIVER=database
            - SESSION_LIFETIME=120
            - QUEUE_CONNECTION=database

            # Mail Configuration
            - MAIL_MAILER=${MAIL_MAILER:-smtp}
            - MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
            - MAIL_PORT=${MAIL_PORT:-587}
            - MAIL_USERNAME=${MAIL_USERNAME}
            - MAIL_PASSWORD=${MAIL_PASSWORD}
            - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}
            - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@ikapsi.horus.my.id}
            - MAIL_FROM_NAME="${MAIL_FROM_NAME:-iKAPSI UHO}"

            # Optional: Run seeders on first start
            - RUN_SEEDERS=${RUN_SEEDERS:-false}

        volumes:
            - ./storage:/var/www/html/storage
            - ikapsi-uploads:/var/www/html/public/storage
        networks:
            - ikapsi-net
            - nginx-proxy
        expose:
            - "80"
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost/"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    # Optional: phpMyAdmin for database management
    ikapsi-phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        container_name: ikapsi-phpmyadmin
        restart: unless-stopped
        depends_on:
            - ikapsi-db
        environment:
            - PMA_HOST=ikapsi-db
            - PMA_PORT=3306
            - PMA_USER=root
            - PMA_PASSWORD=${DB_ROOT_PASSWORD:-root_password_change_me}
            - UPLOAD_LIMIT=256M
        networks:
            - ikapsi-net
            - nginx-proxy
        expose:
            - "80"
        profiles:
            - tools

networks:
    ikapsi-net:
        driver: bridge
    nginx-proxy:
        external: true

volumes:
    ikapsi-mysql-data:
        driver: local
    ikapsi-uploads:
        driver: local
