# Complete Setup Guide: Local & Production Environment Parity

## Problem Summary

**What was broken:**
- Production had 500 errors because `public/build/` (frontend assets) were missing
- Build tools (bun/node) not installed in production Docker
- Local built with bun, production couldn't build
- Environments were different, causing deployment issues

**Root cause:**
- `.gitignore` excluded `public/build/` 
- No build process in production
- Docker didn't include build tools

---

## Solution: Commit Build Artifacts

We've adopted a **simple, reliable approach** used by many Laravel projects:

### ‚úÖ Build assets locally ‚Üí Commit to git ‚Üí Deploy everywhere

**Benefits:**
1. ‚úÖ **100% Environment Parity** - Same build files everywhere
2. ‚úÖ **Fast Deployments** - No build step needed (just `git pull`)
3. ‚úÖ **Reproducible** - Same exact assets every time
4. ‚úÖ **Simple** - No complex Docker multi-stage builds
5. ‚úÖ **Reliable** - No build failures in production

---

## Setup Instructions

### 1. Install Bun (Local Development Machine)

```bash
curl -fsSL https://bun.sh/install | bash
source ~/.bashrc  # or ~/.zshrc
```

Verify installation:
```bash
bun --version
```

### 2. Setup Pre-commit Hook (Optional but Recommended)

This automatically builds assets when frontend files change:

```bash
cp pre-commit.sh .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

### 3. Build Assets Locally

```bash
bun run build
```

This creates `public/build/` directory with compiled assets.

### 4. Commit Everything

```bash
git add .
git commit -m "feat: add pre-built assets for production parity"
```

### 5. Deploy to Production

```bash
./deploy-production.sh
```

The script will:
1. Build assets locally (automatically)
2. Check for uncommitted changes
3. Push to GitHub
4. Pull on production
5. Rebuild Docker if needed
6. Run migrations
7. Clear caches
8. Health check

---

## Daily Workflow

### Making Changes

```bash
# 1. Make your code changes
vim app/Http/Controllers/SomeController.php

# 2. If you changed frontend code, build it
bun run build

# 3. Commit everything
git add .
git commit -m "feat: your changes"

# 4. Deploy
./deploy-production.sh
```

### With Pre-commit Hook

If you installed the pre-commit hook:

```bash
# 1. Make changes
# 2. Commit (hook auto-builds if frontend changed)
git add .
git commit -m "feat: your changes"

# 3. Deploy
./deploy-production.sh
```

---

## File Structure

### What's Committed to Git

```
public/
‚îú‚îÄ‚îÄ build/                  ‚Üê NOW COMMITTED (was in .gitignore)
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json
‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ       ‚îú‚îÄ‚îÄ app-*.js
‚îÇ       ‚îú‚îÄ‚îÄ app-*.css
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ hot                     ‚Üê Still ignored
‚îî‚îÄ‚îÄ storage                 ‚Üê Still ignored
```

### What's Ignored

- `/node_modules` - Installed via `bun install`
- `/vendor` - Installed via `composer install`
- `/public/hot` - Vite dev server file
- `/bootstrap/ssr` - SSR build files
- `/resources/js/routes` - Generated by Wayfinder

---

## Deployment Scenarios

### Scenario 1: Only PHP Code Changed

Example: Modified a Controller, Model, or Service

```bash
git commit -m "fix: update user validation"
./deploy-production.sh
```

**What happens:**
- ‚úÖ Quick deployment (~10 seconds)
- ‚úÖ No container rebuild
- ‚úÖ Just restarts the container

### Scenario 2: Frontend Code Changed

Example: Modified React components, added new page

```bash
bun run build  # Build assets
git add public/build
git commit -m "feat: new dashboard widget"
./deploy-production.sh
```

**What happens:**
- ‚úÖ Deployment with new assets (~15 seconds)
- ‚úÖ No container rebuild (assets already in git)
- ‚úÖ Just restarts container

### Scenario 3: Provider/Observer Changed

Example: Added new Observer, modified AppServiceProvider

```bash
git commit -m "feat: add CategoryObserver"
./deploy-production.sh
```

**What happens:**
- ‚ö†Ô∏è  Full container rebuild (~2-3 minutes)
- ‚úÖ Fresh PHP code loaded
- ‚úÖ Automatic cache clearing

### Scenario 4: Database Schema Changed

Example: New migration added

```bash
git commit -m "feat: add posts table migration"
./deploy-production.sh
```

**What happens:**
- ‚úÖ Runs `php artisan migrate --force`
- ‚úÖ Applies new schema changes
- ‚úÖ Quick deployment

---

## Troubleshooting

### Problem: Assets not loading after deployment

**Symptoms:**
- Blank page
- Console errors: "Failed to load module"
- 404 errors for `/build/assets/*`

**Solution:**
```bash
# Rebuild assets locally
bun run build

# Commit the new build
git add public/build
git commit -m "chore: rebuild assets"

# Deploy
./deploy-production.sh
```

### Problem: Stale PHP code (Observer not working)

**Symptoms:**
- Observer events not firing
- Provider changes not applied
- Old behavior persists

**Solution:**
```bash
# Force container rebuild
ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose down && docker-compose up -d --build"
```

### Problem: 500 Error after deployment

**Symptoms:**
- HTTP 500 on all pages
- Error logs show cache issues

**Solution:**
```bash
# Clear all caches
ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && \
  docker-compose exec -T ikapsi-app php artisan optimize:clear && \
  docker-compose restart ikapsi-app"
```

### Problem: Build fails locally

**Symptoms:**
- `bun run build` errors
- Vite compilation errors

**Solution:**
```bash
# Clean install
rm -rf node_modules
bun install
bun run build
```

---

## Environment Comparison

| Aspect | Local | Production |
|--------|-------|------------|
| **OS** | Your machine | Ubuntu VPS |
| **Database** | SQLite | MySQL 8.0 |
| **Web Server** | `php artisan serve` | Apache (Docker) |
| **PHP** | Your version | 8.3 (Docker) |
| **Assets** | `public/build/` (committed) | `public/build/` (from git) |
| **Build Tool** | Bun (installed) | Not needed (uses committed files) |
| **Caching** | File cache | Database cache |

**Key Point:** Assets are built ONCE (locally), used EVERYWHERE (committed to git).

---

## Why This Approach?

### Alternative 1: Build in Docker (‚ùå Rejected)

```dockerfile
FROM node:20 AS builder
RUN npm install && npm run build
FROM php:8.3
COPY --from=builder /app/build ./build
```

**Problems:**
- Slow builds (5-10 minutes)
- Complex Dockerfile
- Requires PHP in builder stage for Wayfinder
- More points of failure

### Alternative 2: Build on Production Server (‚ùå Rejected)

```bash
ssh prod "cd app && npm install && npm run build"
```

**Problems:**
- Requires Node.js/Bun on production server
- Extra dependencies to maintain
- Slower deployments
- Build could fail in production

### Our Choice: Commit Build Files (‚úÖ Chosen)

```bash
# Local: bun run build && git commit
# Production: git pull (done!)
```

**Benefits:**
- ‚úÖ Fast deployments
- ‚úÖ Simple setup
- ‚úÖ Reproducible builds
- ‚úÖ No production build tools needed
- ‚úÖ Industry-standard approach

---

## Monitoring & Verification

### Check Production Status

```bash
curl -I https://ikapsi.horus.my.id
# Should return: HTTP/1.1 200 OK
```

### View Production Logs

```bash
ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose logs -f ikapsi-app"
```

### Test Database Connection

```bash
ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose exec -T ikapsi-app php artisan tinker --execute='DB::connection()->getPdo();'"
```

### Verify Assets Loaded

```bash
curl https://ikapsi.horus.my.id/build/manifest.json
# Should return JSON with asset paths
```

---

## Security Notes

### Build Files in Git - Is This Safe?

**Yes!** Build files contain:
- ‚úÖ Minified JavaScript (already obfuscated)
- ‚úÖ Compiled CSS
- ‚úÖ No secrets or API keys
- ‚úÖ Public assets meant to be served to browsers

**What we DON'T commit:**
- ‚ùå `.env` files (gitignored)
- ‚ùå `vendor/` directory (gitignored)
- ‚ùå `node_modules/` (gitignored)
- ‚ùå Database files (gitignored)
- ‚ùå Storage files (gitignored)

---

## Checklist: Deployment Readiness

Before each deployment:

- [ ] Frontend built: `bun run build`
- [ ] Tests passing: `composer run test`
- [ ] No uncommitted changes: `git status`
- [ ] Build files committed: `git add public/build`
- [ ] Migrations created (if needed)
- [ ] `.env` variables updated (if needed)

After deployment:

- [ ] Site accessible: https://ikapsi.horus.my.id
- [ ] No errors in logs
- [ ] New features working
- [ ] Database migrations applied

---

## Quick Commands Reference

| Task | Command |
|------|---------|
| Build assets | `bun run build` |
| Deploy to production | `./deploy-production.sh` |
| Rollback | `./rollback-production.sh` |
| View logs | `ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose logs -f"` |
| Clear caches | `ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose exec -T ikapsi-app php artisan optimize:clear"` |
| Rebuild containers | `ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose up -d --build"` |
| Run migrations | `ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose exec -T ikapsi-app php artisan migrate"` |
| Run tinker | `ssh admin@147.93.81.147 "cd ~/Documents/ikapsiUHO && docker-compose exec -T ikapsi-app php artisan tinker"` |

---

## Support

If you encounter issues:

1. **Check logs** - Most issues visible in logs
2. **Clear caches** - Solves 80% of weird issues
3. **Rebuild assets** - If frontend broken
4. **Rebuild container** - If PHP code not updating

**You now have 100% environment parity between local and production! üéâ**
